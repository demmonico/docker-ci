version: '3'

services:

# rename!!! project name. Should be unique throught all docker containers and equal to container_name
  test:
    build:
     # image source
     context: ../../images/ubuntu-apache-php
     args:
      - PHP_VER=7.0
      - GITHUB_TOKEN=58dd77fe95481ad1614a5644a105eaecce79b7d4
    image: ubuntu-apache-php7
# rename!!! project name
    container_name: test
    volumes:
      # webapp code
      - ./app:/var/www/html
      # ssh keys for git
      - ../../config/ssh:/root/.ssh:ro
    networks:
      - proxy_common
      - internal
    links:
# rename!!! first = db container name
      - test-db:db
    env_file:
      - host.env
    environment:
      #- REPOSITORY=git@bitbucket.org:some_repo.git
      - REPO_BRANCH=master
      # name of internal DB host
      - DB_HOST=db
    logging:
      driver: none
    stdin_open: true
    tty: true

# rename!!! db container name
  test-db:
    build:
     context: ../../images/ubuntu-mariadb
    image: ubuntu-mariadb
# rename!!! db container name
    container_name: test-db
    volumes:
      # db tables
      - ./db:/var/lib/mysql
      # custom scripts folder
      #- ./custom:/docker-custom
      # NOTES: for correct work should be setted up CUSTOM_RUN_SCRIPT and/or CUSTOM_RUN_SCRIPT_ONCE env variables at the environment section
      # e.g. CUSTOM_RUN_SCRIPT=/docker-custom/run.sh
    networks:
      - internal
    env_file:
      - host.env
#    environment:
# rename!!! db name (for example set to project's name). If wont be setted then DB wont be created on first run
#      - DB_NAME=test
# remove if unused!!!
#      - CUSTOM_RUN_SCRIPT=/docker-custom/run_db.sh
#      - CUSTOM_RUN_SCRIPT_ONCE=/docker-custom/run_db_once.sh
    logging:
      driver: none
    stdin_open: true
    tty: true

networks:
  proxy_common:
    external: true
  internal:
    driver: bridge
